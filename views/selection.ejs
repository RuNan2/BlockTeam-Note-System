<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì½˜í…ì¸  ì„ íƒ</title>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        body { 
            margin: 0; padding: 0; 
            background-color: #36393f; 
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        
        /* 1. ìƒë‹¨ í—¤ë” */
        .header { 
            height: 60px; background: #202225; border-bottom: 1px solid #18191c;
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 25px; flex-shrink: 0;
        }
        .title { color: white; font-size: 1.2em; font-weight: bold; }
        
        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì‘ê²Œ ê°•ì œ ê³ ì •) */
        .logout-btn { 
            background: #ed4245; 
            color: white; 
            border: none; 
            
            width: auto !important;
            flex-grow: 0 !important;
            
            padding: 0 15px !important; 
            font-size: 13px !important;
            height: 32px !important;       
            line-height: 32px !important;  
            
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
            margin-left: auto; 
        }

        /* 2. ë©”ì¸ ì»¨í…ì¸  (ì¢Œìš° ë¶„í• ) */
        .main-container {
            display: flex; flex: 1; overflow: hidden;
        }

        /* [ì™¼ìª½] ì§„ë£Œê³¼ ëª©ë¡ */
        .dept-sidebar {
            width: 250px; background: #2f3136; 
            border-right: 1px solid #202225;
            display: flex; flex-direction: column;
            padding: 15px; overflow-y: auto;
        }
        .dept-item {
            padding: 15px; margin-bottom: 8px; border-radius: 6px;
            color: #b9bbbe; cursor: pointer; font-weight: bold;
            transition: 0.2s; border: 1px solid transparent;
        }
        .dept-item:hover { background: #36393f; color: white; }
        .dept-item.active { 
            background: #5865f2; color: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* [ì˜¤ë¥¸ìª½] í™˜ì ëª©ë¡ ì˜ì—­ */
        .patient-area {
            flex: 1; padding: 25px; overflow-y: auto;
            display: flex; flex-direction: column;
        }

        /* ê²€ìƒ‰ì°½ */
        .search-box { 
            background: #202225; border: 1px solid #40444b; 
            padding: 12px; border-radius: 8px; color: white; 
            width: 100%; font-size: 1em; margin-bottom: 20px; box-sizing: border-box;
        }
        .search-box:focus { outline: 2px solid #5865f2; }

        /* í™˜ì ê·¸ë¦¬ë“œ */
        .patient-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 15px; 
        }

        /* í™˜ì ì¹´ë“œ ë””ìì¸ */
        .patient-card {
            background: #2f3136; border-radius: 8px; padding: 20px;
            border: 1px solid #202225; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px;
            position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .patient-card:hover { 
            transform: translateY(-3px); 
            border-color: #5865f2; 
            background: #32353b;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .p-name { color: white; font-size: 1.3em; font-weight: bold; margin-bottom: 2px; }
        .p-id { color: #72767d; font-size: 0.9em; font-family: monospace; background: #202225; display: inline-block; padding: 2px 6px; border-radius: 4px; width: fit-content;}
        
        /* ë‹´ë‹¹ì˜ í‘œì‹œ (ë…¸ë€ìƒ‰) */
        .p-incharge { 
            color: #ffd700; font-size: 0.9em; font-weight: bold; margin-top: 10px; 
            padding-top: 8px; border-top: 1px solid #40444b;
            display: flex; align-items: center; gap: 5px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #2f3136; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ¥ ì½˜í…ì¸  ì„ íƒ (Contents Selection)</div>
        <button class="logout-btn" onclick="window.location.href='login.ejs'">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="main-container">
        <div class="dept-sidebar" id="dept-list">
            <div style="color:#72767d; text-align:center; margin-top:20px;">ë¡œë”©ì¤‘...</div>
        </div>

        <div class="patient-area">
            <input type="text" id="search" class="search-box" placeholder="ğŸ” ì„ íƒëœ ì½˜í…ì¸  ë‚´ ê²€ìƒ‰..." onkeyup="filterPatients()">
            
            <h3 id="current-dept-title" style="color:white; margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">
                â—€ ì™¼ìª½ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ì„¸ìš”
            </h3>
            
            <div id="grid" class="patient-grid">
                </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let allDepts = [];
        let allPatients = [];
        let doctorList = [];
        let currentDeptId = null;

        window.onload = () => {
            requestData();
            // â˜… [ì¶”ê°€ë¨] 3ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (Auto-Polling)
            setInterval(requestData, 3000);
        };

        function requestData() {
            ipcRenderer.send('request-metadata');
        }

        ipcRenderer.on('receive-metadata', (e, data) => {
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            allDepts = data.departments || [];
            allPatients = data.patients || [];
            doctorList = data.users || []; 

            // ì‚¬ì´ë“œë°” ê·¸ë¦¬ê¸° (ì´ë¯¸ ê·¸ë ¤ì ¸ ìˆê³  ê°œìˆ˜ê°€ ê°™ìœ¼ë©´ ë‹¤ì‹œ ì•ˆ ê·¸ë¦¼ -> ê¹œë¹¡ì„ ë°©ì§€)
            const sidebar = document.getElementById('dept-list');
            // í˜‘ì§„ íƒ­ í¬í•¨í•´ì„œ ê°œìˆ˜ ê³„ì‚° (í˜‘ì§„ 1ê°œ + ì§„ë£Œê³¼ Nê°œ)
            const currentItemCount = sidebar.querySelectorAll('.dept-item').length;
            const newItemCount = allDepts.length + 1; // +1ì€ í˜‘ì§„ íƒ­

            if (currentItemCount !== newItemCount) {
                renderDepartments();
            }
            
            // â˜… ë°ì´í„°ê°€ ê°±ì‹ ë˜ì—ˆìœ¼ë¯€ë¡œ, í˜„ì¬ ë³´ê³  ìˆëŠ” í™˜ì ëª©ë¡ë„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
            if (currentDeptId) {
                filterPatients();
            }
        });

        // 1. ì§„ë£Œê³¼ ëª©ë¡ ê·¸ë¦¬ê¸° (ì™¼ìª½)
        function renderDepartments() {
            const sidebar = document.getElementById('dept-list');
            sidebar.innerHTML = ''; 

            // â˜… [ì¶”ê°€ë¨] í˜‘ì§„(Consultation) - ì „ì²´ í™˜ì ê²€ìƒ‰ íƒ­
            const consultDiv = document.createElement('div');
            consultDiv.className = 'dept-item';
            consultDiv.innerText = 'ğŸ¤ ì „ì²´ ê²€ìƒ‰';
            consultDiv.style.color = '#3ba55c'; // ë…¹ìƒ‰ìœ¼ë¡œ ê°•ì¡°
            consultDiv.style.borderColor = '#3ba55c';
            consultDiv.onclick = () => selectDept('CONSULT', 'ì „ì²´', consultDiv);
            sidebar.appendChild(consultDiv);

            if (allDepts.length === 0) {
                sidebar.innerHTML += '<div style="padding:10px; color:#72767d;">ë“±ë¡ëœ ì½˜í…ì¸  ì—†ìŒ</div>';
                return;
            }

            allDepts.forEach(d => {
                const div = document.createElement('div');
                div.className = 'dept-item';
                div.innerText = d.name; 
                div.onclick = () => selectDept(d.id, d.name, div);
                sidebar.appendChild(div);
            });
        }

        // 2. ì§„ë£Œê³¼ ì„ íƒ
        function selectDept(deptId, deptName, element) {
            currentDeptId = deptId;
            const items = document.querySelectorAll('.dept-item');
            items.forEach(i => i.classList.remove('active'));
            if(element) element.classList.add('active');

            // í˜‘ì§„ ëª¨ë“œì¼ ë•Œì™€ ì¼ë°˜ ëª¨ë“œì¼ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ ë‹¤ë¥´ê²Œ
            if (deptId === 'CONSULT') {
                document.getElementById('current-dept-title').innerText = `ğŸ¤ ì „ì²´ í•­ëª© ê²€ìƒ‰`;
                document.getElementById('search').placeholder = "ğŸ” ì „ì²´ í•­ëª© ì¤‘ ì´ë¦„/ë²ˆí˜¸ ê²€ìƒ‰...";
            } else {
                document.getElementById('current-dept-title').innerText = `ğŸ“‚ ${deptName} êµ¬ì„± í•­ëª©`;
                document.getElementById('search').placeholder = "ğŸ” ì„ íƒëœ ì½˜í…ì¸  ë‚´ ê²€ìƒ‰...";
            }
            
            document.getElementById('search').value = '';
            filterPatients();
        }

        // 3. í™˜ì í•„í„°ë§
        function filterPatients() {
            if (!currentDeptId) return; 

            const keyword = document.getElementById('search').value.toLowerCase();
            
            const filtered = allPatients.filter(p => {
                // â˜… [í•µì‹¬] í˜‘ì§„(CONSULT) ëª¨ë“œì´ë©´ ì§„ë£Œê³¼ ìƒê´€ì—†ì´ ê²€ìƒ‰
                const matchDept = (currentDeptId === 'CONSULT') ? true : (p.deptId === currentDeptId);
                const matchKeyword = p.name.toLowerCase().includes(keyword) || p.id.toLowerCase().includes(keyword);
                return matchDept && matchKeyword;
            });

            renderPatientGrid(filtered);
        }

        function renderPatientGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            if (list.length === 0) {
                grid.innerHTML = '<div style="color:#72767d; padding:20px 0; font-size:1.1em; grid-column: 1 / -1;">í•´ë‹¹ ì¡°ê±´ì˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.forEach(p => {
                let inChargeText = '<span style="color:#72767d; font-weight:normal;">ë°°ì • ì•ˆë¨</span>';
                if (p.inChargeId) {
                    const doc = doctorList.find(u => u.id === p.inChargeId);
                    if (doc) {
                        const major = doc.major ? `(${doc.major})` : '';
                        inChargeText = `ğŸ‘‘ ${doc.name} ${major}`;
                    } else {
                        inChargeText = `ğŸ‘‘ ${p.inChargeId}`;
                    }
                }

                const div = document.createElement('div');
                div.className = 'patient-card';
                div.onclick = () => {
                    ipcRenderer.send('patient-selected', p); 
                };
                
                // í˜‘ì§„ ëª¨ë“œì¼ ë•ŒëŠ” í™˜ìê°€ ì–´ëŠ ê³¼ì¸ì§€ ë³´ì—¬ì£¼ëŠ” ê²Œ ì¢‹ìŒ
                const deptTag = (currentDeptId === 'CONSULT') 
                    ? `<span style="background:#5865f2; font-size:0.7em; padding:2px 5px; border-radius:3px; float:right;">${p.deptId}</span>` 
                    : '';

                div.innerHTML = `
                    <div class="p-name">${p.name} ${deptTag}</div>
                    <div><span class="p-id">${p.id}</span></div>
                    <div class="p-incharge">
                        ${inChargeText}
                    </div>
                `;
                grid.appendChild(div);
            });
        }
    </script>
</body>
</html>