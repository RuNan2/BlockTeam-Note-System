<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì°¨íŠ¸ ì‘ì„±</title>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* 1. ë ˆì´ì•„ì›ƒ */
        .container { 
            display: grid; grid-template-columns: 2fr 1fr; 
            gap: 25px; padding: 25px; height: 94vh; box-sizing: border-box; 
            max-width: 1600px; margin: 0 auto;
        }
        
        .chart-section, .history-section { 
            background: var(--panel-color); padding: 25px; 
            border-radius: 12px; display: flex; flex-direction: column; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 100%; overflow: hidden; position: relative;
        }

        /* 2. ì…ë ¥ì°½ ì˜ì—­ */
        .input-scroll-area {
            flex: 1; overflow-y: auto; padding: 5px 10px 5px 5px; 
            margin-bottom: 15px; min-height: 0; position: relative; z-index: 1; 
        }

        /* 3. ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        textarea { 
            width: 100%; box-sizing: border-box; height: 170px; margin-bottom: 15px; 
            background: #40444b; border: 1px solid #2f3136; color: white; 
            padding: 12px; border-radius: 6px; resize: none; font-size: 1em; line-height: 1.4;
            -webkit-app-region: no-drag !important;
            font-family: 'Segoe UI', sans-serif; /* í°íŠ¸ í†µì¼ */
        }
        textarea:focus { outline: 2px solid #5865f2; outline-offset: -2px; background: #40444b; }
        
        label { color: #b9bbbe; font-weight: bold; margin-bottom: 5px; display: block; }
        
        /* 4. ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìƒì„¸ë³´ê¸°ìš©) */
        .modal-overlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            justify-content: center; align-items: center;
        }
        .view-box { 
            background: #2f3136; padding: 30px; border-radius: 12px; 
            border: 1px solid #3ba55c; width: 600px; max-height: 80vh; 
            display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        .view-header { border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .view-content { overflow-y: auto; flex: 1; padding-right: 10px; }
        
        .soap-row { margin-bottom: 15px; }
        .soap-label { color: white; font-weight: bold; display: block; margin-bottom: 5px; font-size: 1.05em; }
        
        /* â˜… [ì¤‘ìš”] í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸° (ì¤„ë°”ê¿ˆ ìœ ì§€) */
        .soap-text { 
            background: #202225; padding: 10px; border-radius: 6px; 
            color: #dcddde; 
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ, ë„ì–´ì“°ê¸° ìœ ì§€ */
            line-height: 1.5; 
            border: 1px solid #2f3136; 
            font-size: 1em;
        }

        /* 5. í™˜ì ì •ë³´ í—¤ë” */
        .patient-info { 
            background: #202225; padding: 20px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid #2f3136; flex-shrink: 0; 
        }
        .p-tag { background: #5865f2; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; margin-right: 10px; font-weight: bold; }
        
        /* í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 10px; margin-top: auto; flex-shrink: 0; }
        
        .btn-back { 
            flex: 0.8; background: #2f3136; color: #b9bbbe; border: 1px solid #40444b; 
            padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: 0.2s;
        }
        .btn-back:hover { background: #ed4245; color: white; border-color: #ed4245; }

        .btn-reset { 
            flex: 1; background: #4f545c; color: white; border: none; 
            padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: 0.2s; 
        }
        .btn-reset:hover { filter: brightness(1.1); transform: translateY(-2px); }

        #btn-save-action { 
            flex: 2; background: #5865f2; color: white; border: none; 
            padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: 0.2s;
        }
        #btn-save-action:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        ul { list-style: none; padding: 0; overflow-y: auto; flex: 1; padding-right: 5px; }
        li.history-item { background: #2f3136; margin-bottom: 15px; padding: 20px; border-radius: 8px; border: 1px solid #202225; cursor: pointer; transition: 0.2s; }
        li.history-item:hover { border-color: #5865f2; transform: translateX(5px); }
        
        .history-date { color: #99aab5; font-size: 0.85em; }
        .history-writer { color: #ffd700; font-size: 0.9em; font-weight: bold; } 
        .writer-major { color: #ffd700; font-size: 0.85em; font-weight: normal; margin-left: 3px; }
        .history-summary { color: white; font-weight: bold; font-size: 1.05em; margin-top: 8px; }
        
        #viewer-msg {
            display: none; flex: 1; justify-content: center; align-items: center; 
            color: #72767d; font-size: 1.5em; border: 3px dashed #40444b; 
            border-radius: 12px; margin-bottom: 20px; text-align: center; background: #2f3136;
        }

        ::-webkit-scrollbar { width: 8px; background: #2f3136; }
        ::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="view-modal" class="modal-overlay">
        <div class="view-box">
            <div class="view-header">
                <div>
                    <h2 style="color:white; margin:0;">ğŸ“„ ì°¨íŒ… ìƒì„¸</h2>
                    <div style="color:#b9bbbe; margin-top:5px; font-size:0.9em;">
                        ì‘ì„±ì¼: <span id="v-date" style="color:white;">-</span> | ì‘ì„±ì: <span id="v-writer" style="color:#ffd700;">-</span>
                    </div>
                </div>
            </div>
            
            <div class="view-content">
                <div class="soap-row"><span class="soap-label">Description (ì„¤ëª…)</span><div id="v-s" class="soap-text"></div></div>
                <div class="soap-row"><span class="soap-label">Objective (ê°ê´€ì  ì‚¬ì‹¤ ë° ëª©í‘œ)</span><div id="v-o" class="soap-text"></div></div>
                <div class="soap-row"><span class="soap-label">Assessment (ì§„ë‹¨ ë° í‰ê°€)</span><div id="v-a" class="soap-text"></div></div>
                <div class="soap-row"><span class="soap-label">Plan (ê³„íš)</span><div id="v-p" class="soap-text"></div></div>
            </div>
            
            <div style="margin-top:20px; display:flex; justify-content: flex-end; gap: 10px;">
                <button onclick="loadFromHistory()" style="padding:10px 20px; background:#3ba55c; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="closeView()" style="padding:10px 20px; background:#4f545c; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="chart-section">
            <div class="patient-info">
                <div style="display:flex; align-items:center;">
                    <span class="p-tag">í•­ëª©</span> 
                    <span id="p-name" style="font-size: 1.3em; font-weight: bold;">-</span>
                    <span style="color:#72767d; margin: 0 15px;">|</span>
                    <span id="p-id" style="color:#b9bbbe; font-size: 1.1em;">-</span>
                </div>
                <div style="text-align: right;">
                    <div id="p-incharge" style="color:#ffd700; font-size: 1.05em; font-weight: bold;">ë‹´ë‹¹: -</div>
                    <div id="p-dept" style="color:#5865f2; font-weight: bold; margin-top:5px;">-</div>
                </div>
            </div>

            <div class="input-scroll-area" id="input-area">
                <label>Description (ì„¤ëª…)</label> <textarea id="s" placeholder="ì¦ìƒ, ë¬¸ì œì , í•´ì•¼í•  ì¼ ë“± í•­ëª©ì— ëŒ€í•œ ì„¤ëª…"></textarea>
                <label>Objective (ê°ê´€ì  ì‚¬ì‹¤ ë° ëª©í‘œ)</label> <textarea id="o" placeholder="ê´€ì°° ì†Œê²¬, ê°ê´€ì  ì •ë³´, ë¦¬ìŠ¤íŠ¸ì—…"></textarea>
                <label>Assessment (ì§„ë‹¨ ë° í‰ê°€)</label> <textarea id="a" placeholder="ë¬¸ì œì  ì§„ë‹¨, í‰ê°€, ì§„í–‰ë„"></textarea>
                <label>Plan (ê³„íš)</label> <textarea id="p" placeholder="ì•ìœ¼ë¡œì˜ ê³„íš"></textarea>
            </div>

            <div id="viewer-msg">
                <div>
                    ğŸ”’ <b>ê¸°ë¡ ì—´ëŒ ì „ìš©</b><br>
                    <span style="font-size:0.6em; font-weight:normal;">ì…ë ¥ ë° ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-back" onclick="goBack()">â¬… ë’¤ë¡œ</button>
                <button id="btn-reset" class="btn-reset" onclick="hardResetInputs()">ìƒˆ ê¸€ (Reset)</button>
                <button id="btn-save-action" onclick="saveData()">ğŸ’¾ ì €ì¥í•˜ê¸° (Save)</button>
            </div>
        </div>

        <div class="history-section">
            <div style="display:flex; align-items:center; gap: 15px; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px; flex-shrink:0;">
                <h3 style="margin:0; color:white; border:none; padding:0; font-size:1.3em;">ğŸ“‹ ì°¨íŒ… ê¸°ë¡ (History)</h3>
                <button onclick="requestRefresh()" style="width: auto; background:#4f545c; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:0.8em;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <ul id="history-list">
                <li style="color:#72767d; text-align:center; padding:40px; border: 2px dashed #40444b; border-radius: 8px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        // ë§ˆí¬ë‹¤ìš´ ê´€ë ¨ ì½”ë“œ ì‚­ì œë¨

        let currentChartId = null; 
        let currentViewData = null; 
        let doctorList = [];
        let currentPatientInfo = null;
        let myRole = 'doctor'; 

        window.onload = () => {
            ipcRenderer.send('request-patient-data');
            ipcRenderer.send('request-metadata');
        };

        function goBack() { window.location.href = 'selection.ejs'; }

        ipcRenderer.on('init-user-role', (e, role) => {
            myRole = role;
            if (role === 'viewer') {
                document.getElementById('input-area').style.display = 'none';
                document.getElementById('viewer-msg').style.display = 'flex';
                document.getElementById('btn-save-action').style.display = 'none';
                document.getElementById('btn-reset').style.display = 'none';
            } else {
                document.getElementById('input-area').style.display = 'block';
                document.getElementById('viewer-msg').style.display = 'none';
                document.getElementById('btn-save-action').style.display = 'block';
                document.getElementById('btn-reset').style.display = 'block';
            }
        });

        ipcRenderer.on('receive-metadata', (e, data) => {
            if(data.users) {
                doctorList = data.users;
                renderHeader();
            }
        });

        ipcRenderer.on('init-patient-data', (e, patient) => {
            if(!patient) return;
            currentPatientInfo = patient;
            renderHeader();
            ipcRenderer.send('request-history', patient.id);
            hardResetInputs();
        });

        function renderHeader() {
            if(!currentPatientInfo) return;
            document.getElementById('p-name').innerText = currentPatientInfo.name;
            document.getElementById('p-id').innerText = currentPatientInfo.id;
            document.getElementById('p-dept').innerText = currentPatientInfo.deptId || 'General';

            let inChargeText = 'ë°°ì • ì•ˆë¨';
            const docId = currentPatientInfo.inChargeId;
            if (docId) {
                inChargeText = docId;
                if (doctorList.length > 0) {
                    const doc = doctorList.find(u => u.id === docId);
                    if (doc) {
                        const major = doc.major ? `(${doc.major})` : '';
                        inChargeText = `${doc.name} ${major}`;
                    }
                }
            }
            document.getElementById('p-incharge').innerText = `ë‹´ë‹¹: ${inChargeText}`;
        }

        ipcRenderer.on('load-history', (e, historyData) => {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (!historyData || historyData.length === 0) {
                list.innerHTML = '<li style="color:#72767d; text-align:center; padding:40px; border: 2px dashed #40444b; border-radius: 8px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            historyData.reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                const dateStr = new Date(item.savedAt).toLocaleString();
                const sData = item.soapData || {}; 
                const showA = sData.a || sData.A || '';
                const showS = sData.s || sData.S || '';
                const writerName = item.doctorName || item.doctorId; 
                const writerMajor = item.doctorMajor ? `(${item.doctorMajor})` : '';

                li.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="history-date">${dateStr}</span>
                        <span class="history-writer">
                            ${writerName}<span class="writer-major">${writerMajor}</span>
                        </span>
                    </div>
                    <div class="history-summary">${showA ? '[Dx] ' + showA : '[Sx] ' + (showS || 'ë‚´ìš© ì—†ìŒ')}</div>
                `;
                li.onclick = () => openView(item);
                list.appendChild(li);
            });
        });

        // â˜… [ìƒì„¸ ë³´ê¸°] í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì¶œë ¥ (innerText ì‚¬ìš©)
        function openView(item) {
            currentViewData = item;
            
            const data = item.soapData;
            const writerName = item.doctorName || item.doctorId;
            const writerMajor = item.doctorMajor ? `(${item.doctorMajor})` : '';

            document.getElementById('v-date').innerText = new Date(item.savedAt).toLocaleString();
            document.getElementById('v-writer').innerText = `${writerName} ${writerMajor}`;

            document.getElementById('v-s').innerText = data.s || data.S || '-';
            document.getElementById('v-o').innerText = data.o || data.O || '-';
            document.getElementById('v-a').innerText = data.a || data.A || '-';
            document.getElementById('v-p').innerText = data.p || data.P || '-';

            document.getElementById('view-modal').style.display = 'flex';
        }

        function closeView() {
            document.getElementById('view-modal').style.display = 'none';
        }

        function loadFromHistory() {
            if (myRole === 'viewer') {
                alert('ì—´ëŒ ì „ìš© ëª¨ë“œì—ì„œëŠ” ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!currentViewData) return;

            if (confirm("í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§€ê³ , ì„ íƒí•œ ê¸°ë¡ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const data = currentViewData.soapData;
                
                document.getElementById('s').value = data.s || data.S || '';
                document.getElementById('o').value = data.o || data.O || '';
                document.getElementById('a').value = data.a || data.A || '';
                document.getElementById('p').value = data.p || data.P || '';
                
                const btn = document.getElementById('btn-save-action');
                btn.innerText = "âœ¨ ìƒˆ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ (New Save)";
                btn.style.backgroundColor = "#eb459e";
                
                closeView();
            }
        }

        function hardResetInputs() {
            document.getElementById('s').value = '';
            document.getElementById('o').value = '';
            document.getElementById('a').value = '';
            document.getElementById('p').value = '';
            
            currentChartId = null;
            const btn = document.getElementById('btn-save-action');
            btn.innerText = "ğŸ’¾ ì €ì¥í•˜ê¸° (Save)";
            btn.style.backgroundColor = "#5865f2";
        }

        function saveData() {
            if (myRole === 'viewer') return; 
            const s = document.getElementById('s').value;
            const o = document.getElementById('o').value;
            const a = document.getElementById('a').value;
            const p = document.getElementById('p').value;
            if(!s && !o && !a && !p) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const payload = {
                patientId: currentPatientInfo.id, 
                soapData: { s, o, a, p }
            };
            
            ipcRenderer.send('save-soap-signed', { id: null, soapData: {s,o,a,p} });
        }
        
        function requestRefresh() {
            const pid = document.getElementById('p-id').innerText;
            if(pid && pid !== '-') ipcRenderer.send('request-history', pid);
        }

        ipcRenderer.on('save-success', (e, msg) => {
            alert(msg);
            requestRefresh();
            hardResetInputs(); 
        });
        ipcRenderer.on('save-failed', (e, msg) => alert('ì‹¤íŒ¨: ' + msg));
    </script>
</body>
</html>